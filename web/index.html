<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Marker Clustering</title>
    <style>
        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            margin-top: 0px;
            padding-top: 0px;
        }
        
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            text-align: center;
        }
    </style>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css"> </head>

<body>
    <!--search info-->
    <div class="navbar navbar-default container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="#">Twitter Map</a> </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a>Number Of Twitters:</a></li>
                <li class="active"><a id="numberOfTwitters">250</a></li>
                <li>
                    <a id="searchResult"></a>
                </li>
            </ul>
            <form class="navbar-form navbar-right" role="search">
                <input type="text" id="searchInput">
                <input type="button" value="Search" onclick="searchKeyWord()" class="btn btn-secondary">
                <input type="button" value="Reset" onclick="resetMap()" class="btn btn-secondary"> </form>
        </div>
        <!--/.nav-collapse -->
    </div>
    <!--/.container-fluid -->
    <div id="map"></div>
    <script>
        var esUrl = window.location.href;
        var locationMarkerArray = [];
        var queryMarkerArray = [];
        var infoWindow;
        var maxCount = 10000;
        var currentCount = 0;
        var fetchTime;

        function initMap() {
            clearSearchResult();
            //load data to array: locations, and plot
            fetchTweet(locationMarkerArray);
            //init infowindow
            infoWindow = new google.maps.InfoWindow({
                maxWidth: 350
            });
            realTimeUpdate();
        }
        //call 'fetch' to obtain data
        function fetchTweet(array) {
            $.getJSON(esUrl + "fetch", function (data) {
                putIntoArray(array, data.hits.hits, "_source");
                setNumberOfTweet();
                console.log("result: length" + array.length);
            });
        }
        //real time update
        function realTimeUpdate() {
            fetchTime = setInterval(update, 5000);
        }

        function update() {
            console.log("update data....");
            fetchTweet(locationMarkerArray);
            console.log("locationMarkerArray size: " + locationMarkerArray.length);
        }

        function putIntoArray(array, data, field) {
            if (data.length == 0) {
                //alert("sorry, there is no data.");
                return array;
            }
            var tempArray = [];
            for (var i = 0; i < data.length; i++) {
                var sourceInfo = data[i][field];
                var lat = sourceInfo.location.latitude;
                var lng = sourceInfo.location.longitude;
                //other info
                var text = sourceInfo.text;
                var usernmae = sourceInfo.username;
                var datetime = sourceInfo.date;
                tempArray.push({
                    "lat": lat
                    , "lng": lng
                    , "text": text
                    , "username": usernmae
                    , "datetime": datetime
                });
            }
            // declare map
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 3
                , center: {
                    lat: -28.024
                    , lng: 140.887
                }
            });
            // Create an array of alphabetical characters used to label the markers.
            var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            var markers = tempArray.map(function (location, i) {
                var marker = new google.maps.Marker({
                    position: location
                    , label: labels[i % labels.length]
                , });
                //add listener
                attachInfoWindow(marker, location);
                return marker;
            });
            console.log("what is array:" + array.length);
            array = array.concat(markers);
            currentCount++;
            if (currentCount > maxCount) {
                //stop timer
                clearInterval(fetchTime);
            }
            //plot
            addCluster(array);
            return array;
        }

        function addCluster(markerArray) {
            // declare map
            console.log("markerArray length:" + markerArray.length);
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 3
                , center: {
                    lat: -28.024
                    , lng: 140.887
                }
            });
            for (var i = 0; i < markerArray.length; i++) {
                markerArray[i].setMap(map);
            }
            // Add a marker clusterer to manage the markers.
            var markerCluster = new MarkerClusterer(map, markerArray, {
                imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'
            });
            console.log("set bound...");
            //set bound
            var bounds = new google.maps.LatLngBounds();
            for (var i = 0; i < markerArray.length; i++) {
                bounds.extend(markerArray[i].getPosition());
            }
            map.fitBounds(bounds);
            //update total number of twitters
        }
        //add listener on each gps 
        function attachInfoWindow(marker, location) {
            marker.addListener('click', function () {
                // InfoWindow content
                var content = '<div id="container">' + '<h3>' + location["username"].toString() + '</h3>' + '<p>' + '<span>' + location["text"].toString() + '</span>' + '<p>' + location["datetime"].toString() + '</div>';
                infoWindow.setContent(content);
                infoWindow.open(marker.get('map'), marker);
            });
        }

        function searchKeyWord() {
            //stop timer
            clearInterval(fetchTime);
            //clear map
            clearMarker(locationMarkerArray);
            //search
            var keyword = document.getElementById('searchInput');
            $.getJSON(esUrl + "search?keyword=" + keyword.value, function (data) {
                queryMarkerArray = putIntoArray(queryMarkerArray, data.hits.hits, "_source");
                document.getElementById("searchResult").innerHTML = "Matching result:" + queryMarkerArray.length;
            });
        }

        function clearMarker(markerArray) {
            for (var i = 0; i < markerArray.lastIndexOf; i++) {
                markerArray[i].setMap(null);
            }
        }
        //set numbber of results
        function setNumberOfTweet() {
            document.getElementById('numberOfTwitters').innerHTML = locationMarkerArray.length;
        }
        //clear
        function clearSearchResult() {
            queryMarkerArray = [];
            document.getElementById("searchResult").innerHTML = "";
        }
        //reset to origin
        function resetMap() {
            //clear queryMarkerArray
            //re-plot locationMarkerArray.
            clearSearchResult();
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 3
                , center: {
                    lat: -28.024
                    , lng: 140.887
                }
            });
            console.log("reset locationMarkerArray length: " + locationMarkerArray.length);
            for (var i = 0; i < locationMarkerArray.length; i++) {
                locationMarkerArray[i].setMap(map);
            }
            realTimeUpdate();
        };
    </script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC78_6hsgGIFMN65oEvD-5-6CrU7L__ia0&callback=initMap">
    </script>
</body>

</html>